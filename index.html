<html data-bs-theme="dark">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Rad-Druck</title>
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#191c1f">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <style>
        :root {
            --bs-box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 1);
        }

        .table-active {
            --bs-table-active-bg: rgba(227, 209, 146, 0.2);
        }

        .hide {
            display: none;
        }

        th:first-child,
        td:first-child {
            position: sticky;
            left: 0px;
        }

        #result-table::-webkit-scrollbar {
            display: none;
        }

        .values {
            cursor: pointer;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</head>

<body class="p-3 m-0 border-0 bd-example border-0 pb-4 mb-5">
    <div class="d-grid gap-2 mb-3 justify-content-center" id="weight-row">
        <div class="row gx-1">
            <div class="col text-end">
                <label for="weight" class="col-form-label" data-bs-toggle="tooltip" data-bs-placement="bottom"
                    data-bs-title="(Rider + Bike + Gear)" id="tooltip-weight">Gesamtgewicht:</label>
            </div>
            <div class="col align-middle">
                <div class="input-group has-validation">
                    <input type="number" inputmode="numeric" pattern="[0-9]*" class="form-control" id="weight"
                        placeholder="0" min="34" max="205">
                    <span class="input-group-text">kg</span>
                    <div class="invalid-feedback" id="weight-warning">
                        Weight input between 34 – 205 kg required.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive" id="result-table">
        <table class="table table-bordered table-striped-columns align-middle text-center">
            <thead>
                <tr class="border-0 border-secondary-subtle">
                    <th class="text-warning border-top-0 border-start-0 text-end" data-bs-toggle="tooltip"
                        data-bs-placement="top" data-bs-title="Durchschnitts-&#010;geschwindigkeit">km/h</th>
                    <th class="text-warning border-top values speed-18">18</th>
                    <th class="text-warning border-top values speed-20">20</th>
                    <th class="text-warning border-top values speed-22">22</th>
                    <th class="text-warning border-top values speed-24">24</th>
                    <th class="text-warning border-top values speed-26">26</th>
                    <th class="text-warning border-top values speed-28">28</th>
                    <th class="text-warning border-top values speed-30">30</th>
                </tr>
            </thead>
            <tbody>
                <tr id="new-pavement">
                    <td class="text-start text-info">Neuer<br>Asphalt</td>
                    <td class="values speed-18" id="new-pavement-18"></td>
                    <td class="values speed-20" id="new-pavement-20"></td>
                    <td class="values speed-22" id="new-pavement-22"></td>
                    <td class="values speed-24" id="new-pavement-24"></td>
                    <td class="values speed-26" id="new-pavement-26"></td>
                    <td class="values speed-28" id="new-pavement-28"></td>
                    <td class="values speed-30" id="new-pavement-30"></td>
                </tr>
                <tr id="worn-pavement">
                    <td class="text-start text-info" data-bs-toggle="tooltip" data-bs-placement="right"
                        data-bs-title="Abgenutzter Asphalt / Einige Risse">Abgenutzter<br>Asphalt</td>
                    <td class="values speed-18" id="worn-pavement-18"></td>
                    <td class="values speed-20" id="worn-pavement-20"></td>
                    <td class="values speed-22" id="worn-pavement-22"></td>
                    <td class="values speed-24" id="worn-pavement-24"></td>
                    <td class="values speed-26" id="worn-pavement-26"></td>
                    <td class="values speed-28" id="worn-pavement-28"></td>
                    <td class="values speed-30" id="worn-pavement-30"></td>
                </tr>
                <tr id="cat1-gravel">
                    <td class="text-start text-info" data-bs-toggle="tooltip" data-bs-placement="right"
                        data-bs-title="Feiner Schotter / harter Untergrund">Gravel 1:<br>Eben & hart</td>
                    <td class="values speed-18" id="cat1-gravel-18"></td>
                    <td class="values speed-20" id="cat1-gravel-20"></td>
                    <td class="values speed-22" id="cat1-gravel-22"></td>
                    <td class="values speed-24" id="cat1-gravel-24"></td>
                    <td class="values speed-26" id="cat1-gravel-26"></td>
                    <td class="values speed-28" id="cat1-gravel-28"></td>
                    <td class="values speed-30" id="cat1-gravel-30"></td>
                </tr>
                <tr id="poor-pavement">
                    <td class="text-start text-info" data-bs-toggle="tooltip" data-bs-placement="right"
                        data-bs-title="Schlechter Asphalt / Splittbelag">Schlechter<br>Asphalt</td>
                    <td class="values speed-18" id="poor-pavement-18"></td>
                    <td class="values speed-20" id="poor-pavement-20"></td>
                    <td class="values speed-22" id="poor-pavement-22"></td>
                    <td class="values speed-24" id="poor-pavement-24"></td>
                    <td class="values speed-26" id="poor-pavement-26"></td>
                    <td class="values speed-28" id="poor-pavement-28"></td>
                    <td class="values speed-30" id="poor-pavement-30"></td>
                </tr>
                <tr id="cat2-gravel">
                    <td class="text-start text-info" data-bs-toggle="tooltip" data-bs-placement="right"
                        data-bs-title="Grobkörnigerer Schotter">Gravel 2:<br>Mäßig rau</td>
                    <td class="values speed-18" id="cat2-gravel-18"></td>
                    <td class="values speed-20" id="cat2-gravel-20"></td>
                    <td class="values speed-22" id="cat2-gravel-22"></td>
                    <td class="values speed-24" id="cat2-gravel-24"></td>
                    <td class="values speed-26" id="cat2-gravel-26"></td>
                    <td class="values speed-28" id="cat2-gravel-28"></td>
                    <td class="values speed-30" id="cat2-gravel-30"></td>
                </tr>
                <tr id="cobblestone">
                    <td class="text-start text-info">Kopfstein-<br>pflaster</td>
                    <td class="values speed-18" id="cobblestone-18"></td>
                    <td class="values speed-20" id="cobblestone-20"></td>
                    <td class="values speed-22" id="cobblestone-22"></td>
                    <td class="values speed-24" id="cobblestone-24"></td>
                    <td class="values speed-26" id="cobblestone-26"></td>
                    <td class="values speed-28" id="cobblestone-28"></td>
                    <td class="values speed-30" id="cobblestone-30"></td>
                </tr>
                <tr id="cat3-gravel">
                    <td class="text-start text-info" data-bs-toggle="tooltip" data-bs-placement="right"
                        data-bs-title="Lockerer Schotter / größere Steine">Gravel 3:<br>Grobkörnig</td>
                    <td class="values speed-18" id="cat3-gravel-18"></td>
                    <td class="values speed-20" id="cat3-gravel-20"></td>
                    <td class="values speed-22" id="cat3-gravel-22"></td>
                    <td class="values speed-24" id="cat3-gravel-24"></td>
                    <td class="values speed-26" id="cat3-gravel-26"></td>
                    <td class="values speed-28" id="cat3-gravel-28"></td>
                    <td class="values speed-30" id="cat3-gravel-30"></td>
                </tr>
                <tr id="cat4-gravel">
                    <td class="text-start text-info" data-bs-toggle="tooltip" data-bs-placement="right"
                        data-bs-title="Sehr rau / schwer befahrbar">Gravel 4:<br>Extrem rau</td>
                    <td class="values speed-18" id="cat4-gravel-18"></td>
                    <td class="values speed-20" id="cat4-gravel-20"></td>
                    <td class="values speed-22" id="cat4-gravel-22"></td>
                    <td class="values speed-24" id="cat4-gravel-24"></td>
                    <td class="values speed-26" id="cat4-gravel-26"></td>
                    <td class="values speed-28" id="cat4-gravel-28"></td>
                    <td class="values speed-30" id="cat4-gravel-30"></td>
                </tr>
        </table>
    </div>
    <div class="d-grid gap-2 mb-3 justify-content-center">
        <div class="btn-group" role="group" aria-label="">
            <input type="radio" class="btn-check" name="unit" id="psi" autocomplete="off" checked>
            <label class="btn btn-outline-light btn-sm rounded-start-pill px-3" for="psi">psi</label>
            <input type="radio" class="btn-check" name="unit" id="Bar" autocomplete="off">
            <label class="btn btn-outline-light btn-sm rounded-end-pill px-3" for="Bar">Bar</label>
        </div>
    </div>

    <div class="d-grid gap-2 p-2 fixed-bottom bg-dark-subtle shadow" id="tire-selector">
        <div class="btn-group" role="group" aria-label="">
            <input type="radio" class="btn-check" name="which-tire" id="tire-front" autocomplete="off" value="front">
            <label class="btn btn-outline-primary rounded-start-pill" for="tire-front"
                id="tire-front-label">Vorne<br><strong class="fs-5"></strong></label>
            <input type="radio" class="btn-check" name="which-tire" id="tire-back" autocomplete="off" value="back">
            <label class="btn btn-outline-primary rounded-end-pill" for="tire-back"
                id="tire-back-label">Hinten<br><strong class="fs-5"></strong></label>
        </div>
    </div>

    <div class="accordion mb-4" id="accordionExample">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne" id="accordionName">
                    40 / 622 mm, Mid Range, Triathlon/TT/Track
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <div class="input-group mb-2 has-validation">
                        <div class="form-floating">
                            <select name="tire-width" id="tire-width" class="form-select">
                            </select>
                            <label for="tire-width">Reifen Breite gemessen</label>
                        </div>
                        <span class="input-group-text">mm</span>
                    </div>
                    <div class="input-group mb-2 has-validation">
                        <div class="form-floating">
                            <select name="tire-diameter" id="tire-diameter" class="form-select">
                                <option value="622" selected>700C/29"</option>
                                <option value="571">650C</option>
                                <option value="584">650B/27.5"</option>
                                <option value="559">26"</option>
                            </select>
                            <label for="tire-width">Reifen Durchmesser</label>
                        </div>
                    </div>
                    <div class="input-group mb-2 has-validation">
                        <div class="form-floating">
                            <select name="tire-type" id="tire-type" class="form-select">
                                <option value="high-perf-tubeless-latex">Race Tubeless / Latexschlauch</option>
                                <option value="mid-range-tubeless-latex" selected>Standard Tubeless / Latexschlauch
                                </option>
                                <option value="mid-range-butyl">Standard Butylschlauch</option>
                                <option value="puncture-resistant-tubeless-latex">Pannensicher Tubeless /
                                    Latexschlauch
                                </option>
                            </select>
                            <label for="tire-type">Reifen Art/Material</label>
                        </div>
                    </div>
                    <div class="input-group mb-2 has-validation">
                        <div class="form-floating">
                            <select name="weight-dist" id="weight-dist" class="form-select">
                                <option value="tr-tt-track">50/50 (Triathlon/TT/Track Bike)</option>
                                <option value="road">48/52 (Road Bike)</option>
                                <option value="gravel" selected>47/53 (Gravel Bike)</option>
                                <option value="mountain">46.5/53.5 (Mountain Bike)</option>
                            </select>
                            <label for="weight-dist">Gewichtsverteilung</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
    <script>
        function addMeasuredTireOptions() {
            let select, i, option;
            let min = 20, max = 65;
            select = document.getElementById('tire-width');
            for (i = min; i <= max; i += 1) {
                option = document.createElement('option');
                option.value = i;
                option.text = i + "";
                if (i == 40) option.selected = true;
                select.add(option);
            }
        }

        let weight = $("#weight");
        let tireWidth = $("#tire-width");
        let tireDiameter = $("#tire-diameter");
        let weightDist = $("#weight-dist");
        let tireType = $("#tire-type");

        let surfaceTypes = ["new-pavement", "worn-pavement", "cat1-gravel", "poor-pavement", "cat2-gravel", "cobblestone", "cat3-gravel", "cat4-gravel"];
        let speedTypes = [18, 20, 22, 24, 26, 28, 30];

        const K1_VALUES = {
            // 'track-indoor-wood': 354,
            // 'track-outdoor-wood': 294,
            'new-pavement': 261,
            'worn-pavement': 246.5,
            'cat1-gravel': 235.5,
            'poor-pavement': 225,
            'cat2-gravel': 212.5,
            'cobblestone': 199,
            'cat3-gravel': 187,
            'cat4-gravel': 170
        };

        const WEIGHT_DISTRIBUTIONS = {
            'tr-tt-track': { front: 1, back: 1 },
            'road': { front: 0.985, back: 1.01 },
            'gravel': { front: 0.975, back: 1.02 },
            'mountain': { front: 0.97, back: 1.03 }
        };

        const TIRE_TYPE_FACTORS = {
            'high-perf-tubeless-latex': { front: 1, back: 1 },
            'mid-range-tubeless-latex': { front: 0.97, back: 0.97 },
            'mid-range-butyl': { front: 0.94, back: 0.94 },
            'puncture-resistant-tubeless-latex': { front: 0.91, back: 0.91 }
        };

        function round(value, precision) {
            var multiplier = Math.pow(100, precision || 0) / 5;
            return Math.round(value * multiplier) / multiplier;
        }
        function roundHalf(num) {
            return Math.round(num * 2) / 2;
        }

        function calcCPP(K) {
            let width = Number(tireWidth.val());
            let diameter = Number(tireDiameter.val());
            let num = ((-0.00006 * (width ** 3)) + (0.0079 * (width ** 2)) - (0.4102 * width) + (12.725)) * (-226.44);
            let denom = (((((-0.5 * 9.81) / (K * (20 / width))) + (width + (diameter / 2))) ** 2) - ((width + (diameter / 2)) ** 2))
            return (num / denom)
        }
        function calcSpeedCoeff(speed) {
            let y0 = 10, x0 = 0.97, y1 = 33, x1 = 1.03;
            let num = (x1 * speed) - (x0 * speed) - (x1 * y0) + (x0 * y0) + (y1 * x0) - (x0 * y0);
            let denom = y1 - y0;
            return num / denom
        }

        $(window).on("load", function () {
            if (window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) {
                $("#tire-selector").addClass("pb-4")
            }
            addMeasuredTireOptions();
            for (var iD in localStorage) {
                if (!localStorage.hasOwnProperty(iD)) continue;
                if (iD == "fav") {
                    $("#" + localStorage[iD]).addClass("fav text-bg-warning");
                } else {
                    element = $("#" + iD);
                    if (element.length) {
                        $("#" + iD).val(localStorage[iD]);
                    } else {
                        console.log($("#" + localStorage[iD]))
                        $("#" + localStorage[iD]).prop("checked", true);;
                    }
                }

                setAccordionName();
            }
            calcAll();
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
            const tooltipWeight = bootstrap.Tooltip.getInstance('#tooltip-weight');
            // tooltipWeight.toggleDisabled();
            $("#weight-row").on("focusout", function () {
                tooltipWeight.hide();
            })
            $("#weight").on("focus", function () {
                tooltipWeight.show();
            })
            setActiveTable()
        });
        $("select, input").on("change", function () {
            setAccordionName();
            console.log(this);
            if (this.type != "radio") {
                localStorage.setItem(this.id, this.value);
            } else {
                localStorage.setItem(this.name, this.id);
            }
            calcAll();
        });
        $(".values").on("click", function () {
            localStorage.setItem("fav", this.id)
            $(".fav").removeClass("fav text-bg-warning")
            $(this).addClass("fav text-bg-warning")
            setActiveTable()
            calcAll();
        })
        function setActiveTable() {
            $(".table-active").removeClass("table-active")
            $(".speed-" + $(".fav").attr("id").replace(/.*\w+-(\d\d)/, "$1")).addClass("table-active");
            $(".fav").parent().addClass("table-active")
        }
        function setAccordionName() {
            $("#accordionName").text(
                $("#tire-width").val() + " / " +
                $("#tire-diameter").val() + ", " +
                $("#tire-type").find("option:selected").text().trim().replace(/(\s\/\s).*/m, "") + ", " +
                $("#weight-dist").find("option:selected").text().trim().replace(/^.*\(([^\)]+) Bike\).*$/, "$1")
            )
        }
        function calcAll() {
            for (const surface in K1_VALUES) {
                for (let speed of speedTypes) {
                    calcOne(surface, speed);
                }
            };
        }
        function calcOne(surface, speed) {
            let K1 = K1_VALUES[surface]
            let K = 0.5 * (weight.val() - 50) + K1
            let CPP = calcCPP(K)
            let speedCoeff = calcSpeedCoeff(Number(speed))
            let weightDistCoeff = WEIGHT_DISTRIBUTIONS[weightDist.val()];
            let tireTypeCoeff = TIRE_TYPE_FACTORS[tireType.val()];

            let speedVal = Number(speed) * 0.44704
            let tireWidthVal = Number(tireWidth.val())

            // console.log("weight", weight, "K1", K1, "K", K, "CPP", CPP, "speedCoeff", speedCoeff, "weightDistCoeff", weightDistCoeff, "tireTypeCoeff", tireTypeCoeff)

            let front = (CPP * speedCoeff * weightDistCoeff.front) * tireTypeCoeff.front
            let back = (CPP * speedCoeff * weightDistCoeff.back) * tireTypeCoeff.back

            let unit = $('input[name=unit]:checked').attr("id");

            if (unit == "psi") {
                front = roundHalf(front, 4).toFixed(1)
                back = roundHalf(back, 4).toFixed(1)
            } else {
                front = round(front * 0.0689476, 1).toFixed(2);
                back = round(back * 0.0689476, 1).toFixed(2)
            }

            favElement = $(".fav#" + surface + "-" + speed)
            if (favElement.length) {
                $("#tire-front-label").find("strong").text(front + " " + unit)
                $("#tire-back-label").find("strong").text(back + " " + unit)
            }

            if ($('input[name=which-tire]:checked').attr("id") == "tire-front") {
                $("#" + surface + "-" + speed).text(front);
            } else {
                $("#" + surface + "-" + speed).text(back);
            }
        }
    </script>
</body>

</html>